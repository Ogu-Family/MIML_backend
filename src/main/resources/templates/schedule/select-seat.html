<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Seat Selection</title>
  <style>
    /* Add styling for selected and reserved seats */
    .selected {
      background-color: lightblue;
    }
    .reserved {
      background-color: lightcoral;
    }

    /* Styling for result container */
    #reservationResult {
      margin-top: 20px;
      border: 1px solid #ccc;
      padding: 10px;
      display: none;
    }
  </style>
</head>
<body>
<h2>영화 좌석 목록</h2>
<div id="seatsContainer">
  <div th:each="seat : ${seats}" class="seat">
    <button th:attr="data-seatNameType=${seat.seatNameType}" th:class="${seat.reserved} ? 'reserved' : ''" onclick="toggleSeat(this)">
      <span th:text="${seat.seatNameType}"></span>
      <span th:if="${seat.reserved}" th:text="' (Reserved)'"></span>
    </button>
  </div>
</div>
<button onclick="reserveSelectedSeats()">좌석 선택 완료</button>

<!-- Result container -->
<div id="reservationResult">
  <p><strong>좌석 선택 결과:</strong></p>
  <p><strong>Seat ID:</strong> <span id="seatId"></span></p>
  <p><strong>Ticket ID:</strong> <span id="ticketId"></span></p>
  <p><strong>Seat Name:</strong> <span id="seatNameType"></span></p>
</div>

<script th:inline="javascript">
  // Variable to store the currently selected seat ID
  let selectedSeatName = null;

  // Function to toggle seat selection
  function toggleSeat(button) {
    const seatNameType = button.getAttribute('data-seatNameType');

    // Deselect the currently selected seat if a different one is clicked
    if (selectedSeatName !== null && selectedSeatName !== seatNameType) {
      const previousSelectedButton = document.querySelector('[data-seatNameType="' + selectedSeatName + '"]');
      if (previousSelectedButton) {
        previousSelectedButton.classList.remove('selected');
      }
    }

    if (button.classList.contains('selected')) {
      // Deselect the seat if it is already selected
      button.classList.remove('selected');
      selectedSeatName = null;
    } else {
      // Select the seat
      button.classList.add('selected');
      selectedSeatName = seatNameType;
    }
  }

  // Function to reserve selected seats
  async function reserveSelectedSeats() {
    // Check if any seat is selected
    if (selectedSeatName === null) {
      alert("Please select a seat before reserving.");
      return;
    }

    // Get the scheduleId from the URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const scheduleId = urlParams.get('schedule_id');

    // Prepare the data for the POST request
    const requestData = {
      scheduleId: scheduleId,
      seatNameType: selectedSeatName,
    };

    // Send a POST request to the server to reserve the seat
    const response = await fetch('/api/v1/seats', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(requestData),
    });

    // Handle the response and display the result
    const responseData = await response.json();
    console.log(responseData);

    // Display the result on the page with improved styling
    const resultContainer = document.getElementById('reservationResult');

    // Check if data is available before showing the result
    if (responseData.data) {
      // Show the result div
      resultContainer.style.display = 'block';

      // Update the result content
      document.getElementById('seatId').innerText = responseData.data.seatId;
      document.getElementById('ticketId').innerText = responseData.data.ticketId;
      document.getElementById('seatNameType').innerText = responseData.data.seatNameType;
    } else {
      // Hide the result div if data is not available
      resultContainer.style.display = 'none';
    }
  }
</script>
</body>
</html>
